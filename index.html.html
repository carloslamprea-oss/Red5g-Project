<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estimador IA - Versi√≥n Universal</title>
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 650px; margin: auto; background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #4f46e5; }
        .result { margin-top: 20px; padding: 20px; background: #064e3b; border-radius: 8px; display: none; border: 1px solid #10b981; }
        .error { margin-top: 20px; padding: 15px; background: #7f1d1d; border-radius: 8px; display: none; color: #fecaca; font-size: 0.9em; }
        #status { text-align: center; color: #fbbf24; margin: 10px 0; font-size: 0.9em; display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Estimador Universal (Multi-Modelo)</h2>
    
    <label>API Key de Google</label>
    <input type="password" id="apiKey" placeholder="Pega tu clave AIza... aqu√≠">

    <label>Historia de Usuario</label>
    <textarea id="story" placeholder="Describe la funcionalidad..."></textarea>

    <div class="grid">
        <div>
            <label>Experiencia Dev</label>
            <select id="seniority">
                <option value="2">Junior</option>
                <option value="1.5">Middle</option>
                <option value="1" selected>Senior</option>
            </select>
        </div>
        <div>
            <label>Despliegue</label>
            <div style="font-size: 0.8em; background: #334155; padding: 10px; border-radius: 6px;">
                <input type="checkbox" id="qa" checked> QA (+2h)<br>
                <input type="checkbox" id="pre" checked> Pre-Prod (+2h)<br>
                <input type="checkbox" id="prod" checked> Prod (+4h)
            </div>
        </div>
    </div>

    <button onclick="estimarConFallback()">Analizar con IA</button>

    <div id="status"></div>
    <div id="errorDiv" class="error"></div>
    
    <div id="resultDiv" class="result">
        <p id="aiReason" style="font-style:italic;"></p>
        <hr style="border:0; border-top: 1px solid #065f46; margin: 15px 0;">
        <div style="text-align: center;">
            <span style="font-size: 0.9em;">Estimaci√≥n Final:</span><br>
            <b id="totalHours" style="font-size: 2.5em; color: #34d399;"></b> <small>Horas</small>
        </div>
    </div>
</div>

<script>
async function estimarConFallback() {
    const key = document.getElementById('apiKey').value.trim();
    const story = document.getElementById('story').value.trim();
    const status = document.getElementById('status');
    const errorDiv = document.getElementById('errorDiv');
    const resultDiv = document.getElementById('resultDiv');

    if (!key || !story) return alert("Faltan datos");

    status.style.display = 'block';
    errorDiv.style.display = 'none';
    resultDiv.style.display = 'none';

    // LISTA DE MODELOS A PROBAR (del m√°s nuevo al m√°s compatible)
    const modelos = [
        "gemini-1.5-flash",
        "gemini-1.5-pro",
        "gemini-pro"
    ];

    let exito = false;

    for (const modelo of modelos) {
        if (exito) break;
        
        status.innerText = `‚è≥ Probando modelo: ${modelo}...`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Analiza esta historia y clasif√≠cala en puntos Fibonacci (1,2,3,5,8,13). Responde solo JSON: {"puntos": 5, "razon": "explicacion"}. Historia: ${story}` }] }]
                })
            });

            const data = await response.json();

            if (data.error) {
                console.log(`Modelo ${modelo} fall√≥:`, data.error.message);
                continue; // Prueba el siguiente modelo
            }

            let text = data.candidates[0].content.parts[0].text;
            text = text.replace(/```json/g, "").replace(/```/g, "").trim();
            const json = JSON.parse(text);

            // C√°lculos si hay √©xito
            const seniority = parseFloat(document.getElementById('seniority').value);
            let horasDev = json.puntos * 4 * seniority;
            let horasExtra = 0;
            if(document.getElementById('qa').checked) horasExtra += 2;
            if(document.getElementById('pre').checked) horasExtra += 2;
            if(document.getElementById('prod').checked) horasExtra += 4;

            document.getElementById('aiReason').innerText = `"${json.razon}" (Analizado con ${modelo})`;
            document.getElementById('totalHours').innerText = (horasDev + horasExtra).toFixed(1);
            
            resultDiv.style.display = 'block';
            exito = true;
            status.style.display = 'none';

        } catch (e) {
            console.error(e);
        }
    }

    if (!exito) {
        status.style.display = 'none';
        errorDiv.innerText = "üö® Ninguno de los modelos de Google respondi√≥. Verifica que tu API Key sea correcta y que tengas conexi√≥n a internet.";
        errorDiv.style.display = 'block';
    }
}
</script>

</body>
</html>