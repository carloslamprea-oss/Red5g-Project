<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimador Avanzado V3 + IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #e0f2fe; }
        .dark body { background-color: #1a202c; }
        .card { background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); padding: 2.5rem; }
        .dark .card { background-color: #2d3748; }
        .header-title { color: #1e40af; }
        .dark .header-title { color: #90cdf4; }
        .section-title { color: #10b981; font-weight: 700; margin-bottom: 1rem; border-bottom: 2px solid #f0fdf4; padding-bottom: 0.5rem;}
        .input-field { border-color: #a7f3d0; background-color: #ecfdf5; color: #065f46; }
        .dark .input-field { border-color: #4ade80; background-color: #14532d; color: #d1fae5; }
        .result-box { background-color: #dbeafe; border-color: #93c5fd; color: #1e40af; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(24px); }
        .footer-text { color: #6b7280; font-size: 0.75rem; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-6 flex justify-center items-start min-h-screen">

    <div id="estimatorForm" class="card w-full max-w-4xl space-y-8">
        
        <div class="flex justify-between items-center no-print">
            <h1 class="text-3xl font-black header-title uppercase tracking-tighter">Estimador <span class="text-emerald-500">V3.1</span> + IA</h1>
            <div class="flex items-center space-x-3 bg-gray-50 dark:bg-gray-800 p-2 rounded-xl border">
                <span class="text-xs font-bold text-gray-400">DARK MODE</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-slate-800 dark:to-indigo-950 p-6 rounded-2xl border-2 border-purple-200 dark:border-indigo-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-purple-800 dark:text-purple-300 font-bold flex items-center gap-2 italic">
                    <span class="bg-purple-600 text-white px-2 py-0.5 rounded text-xs not-italic">NEW</span> Asistente Gemini IA
                </h2>
                <input type="password" id="apiKey" placeholder="API KEY Gemini" class="text-[10px] p-2 border rounded-lg w-32 focus:w-48 transition-all">
            </div>
            <textarea id="iaPrompt" rows="2" class="w-full p-3 rounded-xl border text-sm mb-3 dark:bg-slate-900" placeholder="Describe la historia aquí para que Gemini sugiera el ajuste técnico..."></textarea>
            <button id="btnAiAnalyze" class="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg text-sm transition-all shadow-md">✨ ANALIZAR CON IA</button>
            <div id="aiResponseContainer" class="hidden mt-3 p-3 bg-white/50 dark:bg-black/20 rounded-lg text-xs italic border border-purple-100"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <h2 class="section-title">Factores de Estimación Base</h2>
                
                <div class="space-y-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border">
                    <div class="flex justify-between items-center text-sm font-bold">
                        <label>Complejidad Back-End</label>
                        <input type="checkbox" id="logicComplexityToggle" checked>
                    </div>
                    <select id="logicComplexity" class="input-field w-full p-2 rounded-lg text-sm">
                        <option value="4">XS (4h)</option><option value="8">S (8h)</option><option value="16">M (16h)</option>
                        <option value="24" selected>L (24h)</option><option value="32">XL (32h)</option><option value="40">XXL (40h)</option>
                    </select>
                </div>

                <div class="space-y-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border">
                    <div class="flex justify-between items-center text-sm font-bold">
                        <label>Complejidad Front-End</label>
                        <input type="checkbox" id="frontendLogicComplexityToggle" checked>
                    </div>
                    <select id="frontendLogicComplexity" class="input-field w-full p-2 rounded-lg text-sm">
                        <option value="4">XS (4h)</option><option value="8">S (8h)</option><option value="16">M (16h)</option>
                        <option value="24" selected>L (24h)</option><option value="32">XL (32h)</option><option value="40">XXL (40h)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 text-[10px] uppercase font-bold text-gray-500">
                    <div class="p-3 bg-white dark:bg-slate-900 rounded border">Unit Tests: <span id="unitTestTotal" class="text-blue-500 block text-sm">0h</span></div>
                    <div class="p-3 bg-white dark:bg-slate-900 rounded border">Análisis Estático: <span id="staticAnalysisHours" class="text-blue-500 block text-sm">0h</span></div>
                    <div class="p-3 bg-white dark:bg-slate-900 rounded border font-bold">Peer Review: <span id="peerReviewHours" class="text-blue-500 block text-sm">0h</span></div>
                    <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded border-purple-200">Ajuste IA: <input type="number" id="iaAdjustment" value="0" class="w-full bg-transparent text-purple-600 text-sm focus:outline-none"></div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-400">COMPLEJIDAD ADICIONAL</label>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="uiComplexity" class="input-field p-2 rounded-lg text-xs"><option value="0">UI: Ninguna</option><option value="4" selected>UI: Media (4h)</option><option value="12">UI: Alta (12h)</option></select>
                        <select id="integrationComplexity" class="input-field p-2 rounded-lg text-xs"><option value="0" selected>Integración: 0h</option><option value="4">Integración: 4h</option><option value="8">Integración: 8h</option></select>
                        <select id="dataComplexity" class="input-field p-2 rounded-lg text-xs"><option value="0" selected>Datos: 0h</option><option value="4">Datos: 4h</option><option value="12">Datos: 12h</option></select>
                        <select id="documentationComplexity" class="input-field p-2 rounded-lg text-xs"><option value="1">Doc: Baja</option><option value="2" selected>Doc: Media</option><option value="4">Doc: Alta</option></select>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="section-title">Contexto y Calidad</h2>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 space-y-4">
                    <h3 class="text-xs font-black text-blue-800 dark:text-blue-400 uppercase">Multiplicadores</h3>
                    <select id="developerExperience" class="input-field w-full p-2 rounded-lg text-sm"><option value="1.5">Junior</option><option value="1.0" selected>Intermedio</option><option value="0.8">Senior</option></select>
                    <select id="techKnowledge" class="input-field w-full p-2 rounded-lg text-sm"><option value="1.4">Tech Nueva</option><option value="1.0" selected>Tech Competente</option></select>
                    <div class="flex justify-between text-[10px] font-bold">
                        <span>EXP: <b id="mExpDisplay">1.0x</b></span>
                        <span>TEC: <b id="mTecDisplay">1.0x</b></span>
                        <span>AMB: <b id="mAmbDisplay">1.0x</b></span>
                    </div>
                </div>

                <div class="p-4 border rounded-xl space-y-4 bg-gray-50 dark:bg-gray-800">
                    <div class="flex justify-between items-center"><h3 class="text-sm font-bold">Pruebas QA</h3><input type="checkbox" id="qaCycle2Toggle" checked></div>
                    <div class="text-xs space-y-1">
                        <div class="flex justify-between"><span>Ciclo 1:</span> <span id="qaCycle1Hours" class="font-bold text-emerald-600">0h</span></div>
                        <div class="flex justify-between"><span>Ciclo 2:</span> <span id="qaCycle2Hours" class="font-bold text-emerald-600">0h</span></div>
                        <div class="flex justify-between border-t pt-1 font-bold"><span>Total QA:</span> <span id="qaHoursTotal" class="text-blue-600">0h</span></div>
                    </div>
                </div>

                <div class="p-4 border rounded-xl space-y-2 bg-gray-50 dark:bg-gray-800">
                    <div class="flex justify-between items-center"><h3 class="text-sm font-bold italic text-red-600">Stress Testing</h3><input type="checkbox" id="stressToggle" checked></div>
                    <select id="stressScenarioComplexity" class="input-field w-full p-1 rounded-lg text-[10px]"><option value="6" selected>Escenario Medio (6h)</option><option value="12">Escenario Alto (12h)</option></select>
                    <div class="text-right font-bold text-xs">Total Stress: <span id="stressTotal" class="text-red-500">0h</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-1 bg-emerald-600 text-white p-6 rounded-2xl text-center shadow-lg">
                <span class="text-[10px] font-bold opacity-80 uppercase">Final Estimado</span>
                <div class="text-5xl font-black mt-1"><span id="finalEstimate">0</span><span class="text-xl">h</span></div>
            </div>
            <div class="md:col-span-3 grid grid-cols-3 gap-3">
                <div class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-xl border border-amber-200 text-center">
                    <span class="text-[10px] font-bold text-amber-600 uppercase italic">Probable</span>
                    <div id="mostProbableTotal" class="text-xl font-bold text-amber-800 dark:text-amber-200">0h</div>
                </div>
                <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-xl border border-green-200 text-center">
                    <span class="text-[10px] font-bold text-green-600 uppercase italic">Optimista</span>
                    <div id="optimisticTotal" class="text-xl font-bold text-green-800 dark:text-green-200">0h</div>
                </div>
                <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-xl border border-red-200 text-center">
                    <span class="text-[10px] font-bold text-red-600 uppercase italic">Pesimista</span>
                    <div id="pessimisticTotal" class="text-xl font-bold text-red-800 dark:text-red-200">0h</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const FACTORS = { UNIT_TEST_BACK: 0.15, UNIT_TEST_FRONT: 0.15, STATIC_ANALYSIS: 0.10, PEER_REVIEW: 0.07, QA_CYCLE_1: 0.35, QA_CYCLE_2: 0.40, SCENARIO_PROBABLE: 1.35, SCENARIO_OPTIMISTIC: 1.50, SCENARIO_PESSIMISTIC: 1.65 };

            function main() {
                const getV = (id) => parseFloat(document.getElementById(id).value) || 0;
                const isC = (id) => document.getElementById(id).checked;

                // Lógica original recuperada
                const back = isC('logicComplexityToggle') ? getV('logicComplexity') : 0;
                const front = isC('frontendLogicComplexityToggle') ? getV('frontendLogicComplexity') : 0;
                const iaAdj = getV('iaAdjustment');

                // Unit Tests, Análisis y Peer Review
                const utB = back * FACTORS.UNIT_TEST_BACK;
                const utF = front * FACTORS.UNIT_TEST_FRONT;
                const utTotal = utB + utF;
                const staticA = (back + front) * FACTORS.STATIC_ANALYSIS;
                const peerR = (back + front) * FACTORS.PEER_REVIEW;

                // Otros factores
                const others = getV('uiComplexity') + getV('integrationComplexity') + getV('dataComplexity') + getV('documentationComplexity');
                
                // Multiplicadores
                const mExp = getV('developerExperience');
                const mTec = getV('techKnowledge');
                const mAmb = 1.0; // Simplificado pero presente

                const baseDevEffort = (back + front + utTotal + staticA + peerR + others) * mExp * mTec * mAmb;
                
                // QA y Stress
                const qa1 = baseDevEffort * FACTORS.QA_CYCLE_1;
                const qa2 = isC('qaCycle2Toggle') ? qa1 * FACTORS.QA_CYCLE_2 : 0;
                const qaTotal = qa1 + qa2;
                const stress = isC('stressToggle') ? getV('stressScenarioComplexity') : 0;

                const final = baseDevEffort + qaTotal + stress + iaAdj;

                // Actualizar UI
                document.getElementById('finalEstimate').innerText = Math.round(final);
                document.getElementById('unitTestTotal').innerText = utTotal.toFixed(1) + 'h';
                document.getElementById('staticAnalysisHours').innerText = staticA.toFixed(1) + 'h';
                document.getElementById('peerReviewHours').innerText = peerR.toFixed(1) + 'h';
                document.getElementById('qaCycle1Hours').innerText = qa1.toFixed(1) + 'h';
                document.getElementById('qaCycle2Hours').innerText = qa2.toFixed(1) + 'h';
                document.getElementById('qaHoursTotal').innerText = qaTotal.toFixed(1) + 'h';
                document.getElementById('stressTotal').innerText = stress + 'h';
                document.getElementById('mExpDisplay').innerText = mExp.toFixed(1) + 'x';
                document.getElementById('mTecDisplay').innerText = mTec.toFixed(1) + 'x';

                // Escenarios
                document.getElementById('mostProbableTotal').innerText = Math.round(final * FACTORS.SCENARIO_PROBABLE) + 'h';
                document.getElementById('optimisticTotal').innerText = Math.round(final * FACTORS.SCENARIO_OPTIMISTIC) + 'h';
                document.getElementById('pessimisticTotal').innerText = Math.round(final * FACTORS.SCENARIO_PESSIMISTIC) + 'h';
            }

            // Lógica de IA Gemini
            async function analyzeIA() {
                const key = document.getElementById('apiKey').value;
                const prompt = document.getElementById('iaPrompt').value;
                if(!key || !prompt) return alert("Falta API Key o Descripción");
                
                const btn = document.getElementById('btnAiAnalyze');
                btn.innerText = "PROCESANDO...";
                
                try {
                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Analiza: "${prompt}". Responde EXACTO así: ANALISIS: (razonamiento breve) HORAS: (numero entero de ajuste)` }] }] })
                    });
                    const data = await resp.json();
                    const text = data.candidates[0].content.parts[0].text;
                    document.getElementById('aiResponseContainer').innerText = text.match(/ANALISIS:(.*)HORAS/i)?.[1] || "Completado";
                    document.getElementById('aiResponseContainer').classList.remove('hidden');
                    document.getElementById('iaAdjustment').value = text.match(/HORAS:\s*(\d+)/i)?.[1] || 0;
                    main();
                } catch(e) { alert("Error de conexión"); }
                finally { btn.innerText = "✨ ANALIZAR CON IA"; }
            }

            document.querySelectorAll('select, input').forEach(i => i.addEventListener('change', main));
            document.getElementById('btnAiAnalyze').addEventListener('click', analyzeIA);
            document.getElementById('darkModeToggle').addEventListener('change', () => document.documentElement.classList.toggle('dark'));
            document.getElementById('apiKey').value = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('apiKey').addEventListener('change', (e) => localStorage.setItem('gemini_api_key', e.target.value));

            main();
        });
    </script>
</body>
</html>
